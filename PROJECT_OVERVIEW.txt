==============================
ğŸ“ PROJECT OVERVIEW: EASYTRIP AUTOMATOR
==============================

ğŸ—‚ MAPSTRUCTUUR (excl. node_modules)
--------------------------------------
nodeapibackend/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ check-inbox.js              â†’ Haalt nieuwe e-mails op uit de mailbox (catch-all of directe inbox).
â”‚   â”œâ”€â”€ generate-easy-files.js      â†’ POST endpoint: ontvangt JSON, maakt XML, converteert naar .easy en uploadt + mailt.
â”‚   â”œâ”€â”€ generate-xml.js             â†’ Alternatieve route om enkel XML uit JSON te genereren.
â”‚   â”œâ”€â”€ parse-uploaded-pdf.js       â†’ Upload route: ontvangt PDF, voert parser uit, genereert .easy-bestand.
â”‚   â”œâ”€â”€ send-final-email.js         â†’ E-mailservice: verzendt definitieve bestanden of foutmeldingen.
â”‚   â”œâ”€â”€ upload-from-inbox.js        â†’ Upload route: haalt ongelezen inbox-PDFâ€™s op en verwerkt ze.
â”‚   â””â”€â”€ upload-pdf-attachments.js   â†’ Upload route: verwerkt los geÃ¼ploade bijlagen vanuit front-end.
â”‚
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ mailController.js           â†’ Centrale controller voor e-mailgerelateerde functies (nog basic).
â”‚
â”œâ”€â”€ downloads/
â”‚   â””â”€â”€ voorbeeld.easy              â†’ Testbestand of template voor referentie (.easy output).
â”‚
â”œâ”€â”€ parsers/
â”‚   â”œâ”€â”€ parseB2L.js
â”‚   â”œâ”€â”€ parseDFDS.js
â”‚   â”œâ”€â”€ parseEasyfresh.js
â”‚   â”œâ”€â”€ parseJordex.js              â†’ Parser voor Jordex PDF-transportopdrachten (productierijpe versie).
â”‚   â”œâ”€â”€ parseKWE.js
â”‚   â”œâ”€â”€ parseNeelevat.js
â”‚   â””â”€â”€ parseRitra.js
â”‚       â¤· Al deze bestanden zijn klant-specifieke PDF-parsers.
â”‚
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ mailRoutes.js               â†’ Routes voor e-mailinteractie (aangeroepen door controller).
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ attachmentService.js        â†’ Logica voor het verwerken van bijlagen in mails.
â”‚   â”œâ”€â”€ convertXmlToEasyfile.js     â†’ Zet XML string om naar .easy-bestand (bestandsnaam + pad).
â”‚   â”œâ”€â”€ easyFileService.js          â†’ Centrale logicaverwerker van .easy-files (oud / basic).
â”‚   â”œâ”€â”€ emailService.js             â†’ Custom emailfunctie met fallback en foutdetectie.
â”‚   â”œâ”€â”€ generateXmlFromJson.js      â†’ Genereert correcte XML uit een JSON input op basis van Easytrip structuur.
â”‚   â”œâ”€â”€ imapService.js              â†’ Leest e-mailinboxen uit via IMAP (met PDF-parser integratie).
â”‚   â”œâ”€â”€ mailService.js              â†’ Initieert verbinding met Mijndomein SMTP server.
â”‚   â”œâ”€â”€ parseAttachments.js         â†’ Extraheert PDF-bijlagen uit mailbody of headers.
â”‚   â”œâ”€â”€ parsePdfToEasyFile.js       â†’ Roept parser aan en verwerkt tot .easy formaat.
â”‚   â”œâ”€â”€ parsePdfToJson.js           â†’ Zet PDF om naar JSON structuur op basis van specifieke klantparser.
â”‚   â”œâ”€â”€ pdfService.js               â†’ Algemene helper voor pdf-buffer logica.
â”‚   â”œâ”€â”€ sendEmailWithAttachments.js â†’ Stuurt e-mails met gegenereerde .easy-bestanden.
â”‚   â””â”€â”€ uploadPdfAttachmentsToSupabase.js â†’ Uploadt PDFâ€™s naar Supabase bucket.
â”‚
â”œâ”€â”€ tmp/
â”‚   â¤· Tijdelijke opslaglocatie voor gegenereerde bestanden (voor verzending of upload).
â”‚
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ log.js                      â†’ Logging helper (optioneel / onder constructie).
â”‚   â”œâ”€â”€ smtpTransport.js            â†’ Nodemailer transportconfiguratie (gebaseerd op Mijndomein SMTP).
â”‚   â””â”€â”€ supabaseClient.js           â†’ Instantie van Supabase client, gebruikt in de hele backend.
â”‚
â”œâ”€â”€ .env                            â†’ Bevat alle secrets zoals SMTP gegevens, Supabase keys, etc.
â”œâ”€â”€ index.js                        â†’ Entry point voor backend als node-script (niet server).
â”œâ”€â”€ package.json                    â†’ Project dependencies en scripts.
â”œâ”€â”€ package-lock.json               â†’ Exacte dependency lock.
â”œâ”€â”€ README.md                       â†’ (leeg of nog te schrijven)
â””â”€â”€ PROJECT_OVERVIEW.txt            â†’ DIT BESTAND


ğŸ”— GEBRUIKTE TECH STACK
------------------------
- JavaScript (Node.js)
- Supabase (PostgreSQL + Storage)
- Nodemailer (voor SMTP e-mailverzending)
- pdf-parse (voor PDF-tekst extractie)
- dotenv (voor config uit .env)
- fetch (voor JSON-lijstverificatie)
- Vercel (deployment)


ğŸ“¦ GEBRUIKTE PACKAGES
------------------------
- @supabase/supabase-js
- nodemailer
- pdf-parse
- dotenv
- node-fetch (optioneel polyfill voor fetch)


ğŸ“¤ EMAIL
---------
- SMTP is ingesteld via **Mijndomein**, met custom SMTP_HOST, SMTP_USER en SMTP_PASS.
- Er wordt **gÃ©Ã©n Mailgun** gebruikt, ondanks eerdere testcode.
- E-mail wordt verstuurd met nodemailer in:
  - generate-easy-files.js
  - sendEmailWithAttachments.js


ğŸ’¾ OPSLAG & LOGICA
------------------------
- Alle gegenereerde PDF's en .easy-bestanden worden tijdelijk opgeslagen in `/tmp`.
- Upload naar Supabase bucket (public) gebeurt met contentType `text/plain`.
- XML-bestanden worden exact gegenereerd op basis van het Easytrip vereiste formaat.


âœ… ROUTEOVERZICHT
------------------------
| Methode | Route                        | Beschrijving
|---------|------------------------------|-------------------------------
| POST    | /api/generate-easy-files     | Verwerkt JSON naar XML/.easy, uploadt en mailt
| POST    | /api/generate-xml            | Alleen XML-generatie uit JSON
| POST    | /api/parse-uploaded-pdf      | Upload en parser van PDF direct
| POST    | /api/upload-pdf-attachments  | Upload PDF's vanuit frontend (bijlage)
| GET     | /api/check-inbox             | Haalt nieuwe inboxmails op en verwerkt PDF's
| GET     | /api/upload-from-inbox       | Zelfde als check-inbox, triggert volledige flow
| POST    | /api/send-final-email        | Handmatige e-mailtrigger voor bestand


ğŸ§¼ CLI EN ONTWIKKELINGSTIPS
---------------------------
- `rm -rf` werkt niet standaard in Windows PowerShell â†’ gebruik `rd /s /q` of `rimraf` package.
- Bestanden in `/tmp` worden bij iedere Vercel-executie tijdelijk aangemaakt (niet persistent).
- Supabase Edge Functions zijn optioneel via `supabase/functions/` maar nog niet actief.
- JSON-lijsten voor dropdownvalidatie staan in `supabase/lists/` (publieke endpoint via Supabase hosting).


ğŸ§  PARSERSTRATEGIE
---------------------------
- Iedere klant heeft een eigen parser in `/parsers`
- Deze parser extract alle relevante info uit PDF (zoals container type, rederij, referentie etc.)
- Deze JSON wordt doorgestuurd naar `generateXmlFromJson()`
- Die functie valideert + construeert correcte XML
- XML wordt opgeslagen via `convertXmlToEasyfile.js`


ğŸ›  TODO / NEXT STEPS
---------------------------
- Logging systeem uitbreiden in log.js
- Upload-fallback met retry bij Supabase errors
- Parser fallback voor missende velden of foutformaat
- Meer parsers (voor overige klanten zoals Maersk, CMA CGM, etc)
- Frontend upload dashboard integratie


---

## âœ… Werkende onderdelen
- ğŸ“¬ Emails ophalen met PDF-bijlage (extern script)
- ğŸ§  Parser Jordex PDF â†’ JSON (inclusief terminal lookups)
- ğŸ”€ generateXmlFromJson â†’ correct Easytrip XML-formaat
- â˜ï¸ Upload naar Supabase
- ğŸ“© E-mail met bijlage (Mailgun / SMTP werkt)

---

## ğŸ”‘ .env variabelen
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `SUPABASE_LIST_PUBLIC_URL`
- `SUPABASE_EASY_BUCKET`
- `SMTP_HOST`
- `SMTP_PORT`
- `SMTP_USER`
- `SMTP_PASS`
- `FROM_EMAIL`

---

## ğŸ” Routes
- **POST** `/api/generate-easy-files` â†’ ontvangt JSON â†’ maakt en uploadt .easy

---

## ğŸ“Œ Belangrijk
- Parser mag *nooit* zelf interpreteren. Alleen data overnemen of leeg laten.
- Alleen exacte terminalnamen worden geaccepteerd uit Supabase.
- Easytrip vereist `<Volgorde>0</Volgorde>` voor alle locaties.
- De `.easy`-bestanden moeten aan een vaste XML-structuur voldoen.

Laatste update: 2025-06-27

Update 28-06-2025
âœ… Laatste updates verwerkt in de OVERVIEW:

generateXmlFromJson.js bevat nu een veilige safe()-functie om ontbrekende of lege waarden op te vangen met '0'.

Alle referentielijsten worden correct geladen vanaf:
https://pxgpycnzbdapgybtadiz.supabase.co/storage/v1/object/public/referentielijsten/*.json

De fout "Invalid URL" is opgelost door te zorgen dat process.env.PUBLIC_URL correct geladen is vÃ³Ã³r de POST.

Logging van payload + endpoint wordt nu getoond bij iedere aanroep van /api/generate-easy-files, inclusief base64 en laadplaats.

.easy-bestand wordt zelfs bij incomplete data succesvol opgeslagen en verstuurd via SMTP.

Voorbeeld: Order_GeenReferentie_0.easy met volledig correct opgebouwd XML in juiste structuur.

Alle logs, uploadresultaten en foutmeldingen worden netjes weergegeven in Vercel dashboard.



